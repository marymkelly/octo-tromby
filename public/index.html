<!DOCTYPE html>
<html>
<head>
	<title>Tromby Test</title>
	<!-- Load the Paper.js library -->
	<script type="text/javascript" src="js/paper-full.js"></script>
	<script type="text/javascript" src="js/howler.js"></script>
	<!-- Define inlined PaperScript associate it with myCanvas -->
	<script type="text/paperscript" canvas="myCanvas">

	//paper/canvas variables
	var pWidth = view.bounds.width;
	var pHeight = view.bounds.height;
	var midY = pHeight / 2;

	//shape variables
	var width = 100;
	var height = 100;

	var seventh = (pWidth - (width * 1.5)) / 7;

	var rectSize = new Size(width, height);
	var rectPoint = new Point(width , (midY - (rectSize.height/2)));

	var rect = new Shape.Rectangle(rectPoint, rectSize);
	rect.fillColor = 'blue';

	globals.calcPosition = function(s){
		return seventh * s;
	};

	globals.tween = function(num) {
			
		rect.tween({
		    'position.x': num,
		    'fillColor.hue': '+= 90'
		}, {
		    easing: 'easeInOutCubic',
		    duration: 500
		});
	}

	globals.hi = function(){
		testing();
	}

	globals.arrowKey = function(e){
		  if (Key.isDown('ArrowLeft')) {
		  	console.log('arrowleft');
		  } if (Key.isDown('ArrowRight')){
		  	console.log('arrowright');
		  } else {
		  	console.log('not arrowkey');
		  	return;
		  }
	}

	function testing(){
		console.log("paper says hi");
	}
	 
	function onResize(event) {
	   // Whenever the window is resized, recenter the path:
	   //rect.position = view.center;
	}

	// console.log(paper.project._view._id); //paperScope object id
	paper.install(window);  //inject into window global scope

	</script>
</head>

<style>
#myCanvas {
	border: 2px solid red;
}

html,
body {
    height: 100%;
}

/* Scale canvas with resize attribute to full size */
canvas[resize] {
    width: 80vw;
    height: 90vh;
}

</style>


<body>
	<h1 id="headline">Hello World!</h1>
	<canvas id="myCanvas" resize></canvas>


</body>
<script type="text/javascript">

	window.globals = { 

	}

	let activeKey;
	let prevKey = null;
	let pressedKeys = 0;
	let activeSound;
	let prevSound;
	let currentScreenPosition;
	let slidePosition;
	let partial = 0;
	let arrowActive;
	let title = document.getElementById("headline");
	let track;
	let sound;
	let keyData = {};
	

	window.onload = function(){
		
		keyData = {
			a: {
		  		src: ['trombone/long/fLong.mp3', 'trombone/long/bFlatHighLong.mp3', 'trombone/long/bFlatLong.mp3'],
				pos: window.globals.calcPosition(1),
				num: 1
			},
			s: {
		  		src: ['trombone/long/eLong.mp3', 'trombone/long/aLong.mp3', 'sounds/corona.mp3'],
				pos: window.globals.calcPosition(2),
				num: 2
			},
			d: {
		  		src: ['trombone/long/eFlatLong.mp3', 'trombone/long/aFlatLong.mp3', 'sounds/squiggle.mp3'],
				pos: window.globals.calcPosition(3),
				num: 3
			},
			f: {
		  		src: ['trombone/long/dLong.mp3', 'trombone/long/gLong.mp3', 'sounds/strike.mp3'],
				pos: window.globals.calcPosition(4),
				num: 4
			},
			g: {
		  		src: ['trombone/long/dFlatLong.mp3', 'trombone/long/gFlatLong.mp3', 'sounds/piston1.mp3'],
				pos: window.globals.calcPosition(5),
				num: 5
			},
			h: {
		  		src: ['trombone/long/cLong.mp3', 'trombone/long/fLong.mp3', 'sounds/prism3.mp3'],		
				pos: window.globals.calcPosition(6),
				num: 6
			},
			j: {
		  		src: ['trombone/long/bLong.mp3', 'trombone/long/eLong.mp3', 'sounds/dotted-spiral.mp3'],  			
				pos: window.globals.calcPosition(7),
				num: 7
			}
		}

		document.addEventListener('keydown', (e) => {
			pressedKeys++;

			//console.log("key down: " + e.key, "is repeat: " + e.repeat);

			//modifier key = invetval partials 1-3
			//	var arrowStatus = window.globals.arrowKey(e.key);

				if(e.repeat) {  //on repeating/held down key
					pressedKeys--;

					if(sound.playing){


						let checkEnd = sound.duration() - 0.15; //point near end for range to catch seek 
						let currentPlace = sound.seek(); //current track seek placement
						
						if(currentPlace > checkEnd){ //are we getting close to end?
							//reset seek to repeat track
							sound.seek(0.15);
						}
					} 	//console.log("playing: " + sound.playing()); //is sound playing?
				} else { //is not a held down key
					activeKey = e.key;

					if(activeKey === 'ArrowUp') {
						partial = 1;
						// arrowActive = true;
						console.log(activeKey);
					}


					if(activeKey === 'ArrowDown') {
						partial = 2;
						// arrowActive = true;
						console.log(activeKey);
					}

					if(activeKey === 'ArrowLeft') {
						if(slidePosition > 1){
						 slidePosition--;

						let coorKey = getCoorespKey(slidePosition);
						//console.log(coorkey);

						sound = new Howl({
							src: keyData[coorKey].src[partial],
							onfade: function(){
								console.log('faded!');
								this.stop();
							}
						});

						sound.play();
						
						 let x =  window.globals.calcPosition(slidePosition);
						 window.globals.tween(x);
						} else {
							return;
						}
						// arrowActive = true;
						console.log(activeKey);
					}


					if(activeKey === 'ArrowRight') {
						if(slidePosition < 7){
						 slidePosition++;

						let coorKey = getCoorespKey(slidePosition);

						sound = new Howl({
							src: keyData[coorKey].src[partial],
							onfade: function(){
								console.log('faded!');
								this.stop();
							}
						});

						sound.play()

						 let x =  window.globals.calcPosition(slidePosition);
						 window.globals.tween(x);
						} else {
							return;
						}
						// arrowActive = true;
						console.log(activeKey);
					}

					// switch(activeKey) {
					// 	case 'ArrowLeft' : 
					// 		console.log(activeKey);
					// 		break;

					// 	case 'ArrowRight' :
					// 		pos = seventh * 2;
					// 		track = "trombone/e.mp3";
					// 		console.log(activeKey);
					// 		break;

					// 	case 'ArrowUp' :
					// 		partial = 2;
					// 		break;

					// 	case 'ArrowDown' :
					// 		partial = 3;
					// 		break;

					// 	default : 
					// 		partial: 0;
					// 		console.log("not arrow key");
					// 	;
					// }

					if(pressedKeys > 1){
						//prevent sound overlap
						sound.fade(1,0,300);  
					} 
					//console.log(e.key);
					// ~~~ modifier keys yet to be regulated!! ~~~
					if(keyData[e.key]){

					currentScreenPosition = keyData[e.key].pos;
					slidePosition = keyData[e.key].num;

					// var objArr = keyData[e.key];
					// currentScreenPosition = keyData[e.key].pos;
					// console.log(currentScreenPosition);
					// var obj = findObjectByKey(keyData, 'pos', currentScreenPosition);
					// console.log(obj);

					// var key = "key1";
					// var kvpair = { key: key, value: obj[key] };  
					// // { key: "key1", value: "value1" }

					// key = "bogus"
					// var kvpair = { key: key, value: obj[key] };  
					// // { key: "bogus", value: undefined }

						sound = new Howl({
							src: keyData[e.key].src[partial],
							onfade: function(){
								console.log('faded!');
								this.stop();
							}
						});

					} else {
						console.log("no assigned sound");
						//console.log(activeKey);
						return;	
					}
					
					sound.play();
					
					//animation
					window.globals.tween(keyData[event.key].pos);

				}
				
				//console.log("down reported active key: " + activeKey);

		});

		document.addEventListener('keyup', (e) => {
			pressedKeys--;
			//does key up equal last active key?
			if(e.key === 'ArrowUp' || e.key === 'ArrowDown'){
				arrowActive = false;
				partial = 0;
			}
			if(e.key === activeKey){
				sound.fade(1,0,300);
				sound.onfade;
			} else {
				return;
			}

			console.log("key up: " + e.key, "up reported activeKey: " + activeKey);

		});

		// title.addEventListener('click', (e) => {
		// 	console.log("prevSound: " + prevSound, "activeSound: " + activeSound, "playing" + sound.playing());
		// 	console.log("pressedKeys: " + pressedKeys);

		// })

	}

	let slide = function(name, numPosition) {
			this.name = name,
			this.num = numPosition,
			calcScreenPosition = function() {
				return window.globals.calcPosition(this.num);
			}
	}



	function findObjectByKey(array, key, value) {
	    for (var i = 0; i < array.length; i++) {
	        if (array[i][key] === value) {
	            return array[i];
	        }
	    }
	    return null;
	}

	function getCoorespKey(num){
			switch(num) {
			case 1 : 
				return 'a';
				break;

			case 2 :
				return 's';
				break;

			case 3 :
				return 'd';
				break;

			case 4 :
				return 'f';
				break;

			case 5 :
				return 'g';
				break;

			case 6 :
				return 'h';
				break;

			case 7 :
				return 'j';
				break;

			default : 
				console.log("not cooresponding key");
			;
		}

	}

	function callSound(l){
		sound = new Howl({
			src: keyData[l].src[partial],
			onfade: function(){
				console.log('faded!');
				this.stop();
			}
		});
	}



</script>

</html>