<!DOCTYPE html>
<html>
<head>
	<title>Tromby - Trombone Simulator</title>
	<!-- Load the Paper.js library -->
	<script type="text/javascript" src="js/paper-full.js"></script>
	<script type="text/javascript" src="js/howler.js"></script>
	<!-- Define inlined PaperScript associate it with myCanvas -->
	<script type="text/paperscript" canvas="myCanvas">


	//paper/canvas variables
	var pWidth = view.bounds.width; 
	var pHeight = view.bounds.height;
	var midY = pHeight / 2;
	var midX = pWidth / 2;
	var pWidth3; 

	var pSeventh; //= ((pWidth - 250) / 7);
	//shape variables
	var width = 100;
	var height = 100;
	//calculate slide positions
	//var seventh = (pWidth - (width * 1.5)) / 7; //143
	//rectangle for testing position
	var rectSize = new Size(width, height);
	//var rectPoint = new Point(width , (midY - (rectSize.height/2)));

	//trombone vars
	var trombone;
	var bell;
	var slide;
	var slideChild;


	var slSvgSev;
	var initSlideX; //386.6667 center X of slide
	var maxSlideX; //1586.2 max point for center X of slide
	var offset; // // 140 from the right side of canvas 
	var slideSeventh; // equal division of 7 parts //100.07 each

	//slide svg relative ~ not canvas
	var topSlide; //initSlideX - offset; // 245 - static // top of slide and left bound of animation
	var bottomSlide; // 1085 - static
	var leftSlSvg; // ((slide.bounds.width / 2) - (pWidth / 3)); // left endpoint x of slide svg 
	var rightSlSvg; // ((slide.bounds.width / 2) + (pWidth / 3)); // right endpoint x of slide svg 

	// var rectPoint = new Point(width , (midY - (rectSize.height/2)));
	// var rect = new Shape.Rectangle(rectPoint, rectSize);
	// rect.fillColor = 'blue';

	paper.project.importSVG('/images/tspBell.svg', function(onload) { //background trombone image
		trombone = onload;
	
		trombone.bounds.width;
		trombone.position = new Point((pWidth / 3), midY);
		bell = trombone.children[1].children['Layer_4'].children[2];
		bell.fillColor = "#17FFEF";
		console.log(trombone.children);
		// trombone.position = new Point(386.67, midY);
	});

	paper.project.importSVG('/images/tspSlide.svg', function(onload) { //animated trombone slide
		slide = onload;
		
		//console.log(slide.bounds);
		slide.position = new Point((pWidth / 3), midY); 
		// slide.position = new Point(386.67, midY); 

		pWidth3 = (pWidth / 3); // same as initial slide x
		pSeventh = (pWidth / 7);
		var pQuarter = (pWidth * 0.2527); // where slide starts approx, will have to resize for smaller screens

		slSvgSev = (slide.bounds.width / 7); // for calculating max center X
		initSlideX = slide.position.x; 
		//maxSlideX = initSlideX + (slide.bounds.width - slSvgSev); //supposed to be max center X - no go

		leftSlSvg = ((slide.bounds.width / 2) - (pWidth / 3)); // left endpoint x of slide svg 
		rightSlSvg = ((slide.bounds.width / 2) + (pWidth / 3)); // right endpoint x of slide svg - bottom of slide - good
		offset = (pWidth - (slide.bounds.width - (pWidth / 3))); //from right side of canvas 
		topSlide = pQuarter; // should be fixed/closer
		bottomSlide = rightSlSvg; // 1085 - good
		slideSeventh = (bottomSlide - topSlide) / 7; //120 - wrong

		slideChild = slide.children[1].children['Layer_4'].children[0];
		slideChild.fillColor = "#17FFEF";
		console.log(slide);

		console.log("initSlideX" + initSlideX, "leftSlSvg" + leftSlSvg); //385
		console.log("topSlide" + topSlide, "bottomSlide" + bottomSlide);

		var rectPoint = new Point(initSlideX , (midY - (rectSize.height/2)));
		//var rect = new Shape.Rectangle(rectPoint, rectSize);
		//rect.fillColor = 'blue';
		console.log("offset" +  offset, "pWidth3" + pWidth3);
		console.log("slSvgSev" + slSvgSev, "pSeventh" + pSeventh, "slideSeventh" + slideSeventh);

		//slideSeventh
		//slide.strokeColor = "purple";
		//slide.strokeWidth = 2;
		//var rectl = new Shape.Rectangle(new Point(pQuarter ,(midY - (25/2))), new Size(25, 25));
		//rectl.fillColor = 'purple';

		console.log("pW " + pWidth + "pH " + pHeight + "sl " + slide.bounds); 

	});

	function onMouseDown(event) {
		globals.mouseDraggery(event);

	}

	function onMouseDrag(event) {
		globals.mouseDraggery(event);
	}

	globals.mouseDraggery = function(event) {
		if(event.point.x >= (topSlide) && event.point.x <= (bottomSlide - offset)){ //max and min slide range
			if(event.point.x <= (topSlide + 20)) {
				slide.position.x = event.point.x + 125;
			}else if(event.point.x >= (bottomSlide - (offset + 20))){
					slide.position.x = event.point.x + 115;
			}else {
					slide.position.x = event.point.x + 105;
			}
			console.log("mouseDraggery" +  event.point.x)
		}
	}

	globals.getSlideX = function() {
		return slide.position.x;
	}

	globals.moveSlide = function(s){
		var opt = opt;
		var moveSlide = (slSvgSev * (s - 1))/1.77; //114
		var newSlidePos = initSlideX + moveSlide;

		slide.tween({
			'position.x': newSlidePos,
			
		}, {
			easing: 'easeInOutCubic',
		    duration: 200
		});

		bell.tween({
			'fillColor.hue': '+=5'
		}, {
			easing: 'easeInOutCubic',
		    duration: 200
		})

		slideChild.tween({
			'fillColor.hue': '+=5'
		}, {
			easing: 'easeInOutCubic',
		    duration: 200
		})

		console.log("newX " + newSlidePos);
		console.log(slideSeventh);
	};


	globals.backToFirst = function(){
		if(slide.position.x === topSlide){
			console.log('all good!');
			
		} else {
			console.log("working on it shortly");
			globals.moveSlide(1);
		}
	}
	// console.log(paper.project._view._id); //paperScope object id
	paper.install(window);  //inject into window global scope

	</script>
	<link href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Sacramento&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Open+Sans&display=swap" rel="stylesheet">
</head>

<style>
#myCanvas {
	//border: 2px solid red;
}

html,
body {
    height: 100%;
    width: 100%;
    padding: 0;
    margin: 0;
/*    font-family: 'Open Sans', sans-serif;
	font-family: 'Sacramento', cursive;*/
	font-family: 'Architects Daughter', cursive;
	/*font-family: 'Open Sans', sans-serif;*/
    color: white;
    overflow: hidden;
    background: #000428;  /* fallback for old browsers */
	background: -webkit-linear-gradient(to right, #004e92, #000428);  /* Chrome 10-25, Safari 5.1-6 */
	background: linear-gradient(to right, #004e92, #000428); /* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */

}

/* Scale canvas with resize attribute to full size */
canvas[resize] {
    width: 100vw;
    height: 100vh;
    display: block;
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
/*
    width: 1156px;
    height: 529px;*/
}

#bg{
	clip-path: polygon(15% 88%, 86% 87%, 100% 100%, 0% 100%);
	height: 100vh;
	width: 100vw;
	/*background-color: navy;*/
	background-color: #111;
	position: absolute;
}
</style>


<body>
	<div id="bg"></div>
	<h1 id="headline">Note: <span id="note"></span></h1>
	<canvas id="myCanvas" resize></canvas>
</body>
<script type="text/javascript">

	window.globals = {

		reg: 0, 
		testCall: function(num){ 
			var el = document.createElement("h2");

			document.body.appendChild(el); 
			el.innerHTML = "Global Reg is " + num; 
		},
	}

	let activeKey; //most recent key down
	let soundKeys = 0; //track pressed sound keys 
	let sound;
	let register = 0; //note ranges
	let keyData = {};
	let sliding = false; //sliding mouse
	let coorKey; //corresponding 'key' 
	let activeSound = false; //active sound if mousedown
	//let isKeyPress; 
	let initCount = 0; 
	//let arrowKey = 'ArrowLeft' || 'ArrowRight' || 'ArrowUp' || 'ArrowDown';

	let mouseUp; 
	let mouseDown;
	let mouseMove;
	let keyDown
	let keyUp;
	let isLeftRight = false;


	window.onload = function(){

		keyData = {
			KeyA: {
		  		src: [{note: 'F', track: 'trombone/long/fLong.mp3'}, {note: 'B Flat', track: 'trombone/long/bFlatHighLong.mp3'},{note: 'B Flat', track: 'trombone/long/bFlatLong.mp3'}],
				// pos: window.globals.calcPosition(this.num),
				num: 1,
				key: 'KeyA'
			},
			KeyS: {
		  		src: [{note: 'E' , track: 'trombone/long/eLong.mp3'}, {note: 'A', track: 'trombone/long/aLong.mp3'}, {note: 'A', track: 'trombone/long/aLowLong.mp3'}],
				// pos: window.globals.calcPosition(this.num),
				num: 2,
				key: 'KeyS'
			},
			KeyD: {
		  		src: [{note: 'E Flat', track: 'trombone/long/eFlatLong.mp3'}, {note: 'A Flat', track: 'trombone/long/aFlatLong.mp3'}, {note: 'A Flat', track: 'trombone/long/aFlatLowLong.mp3'}],
				// pos: window.globals.calcPosition(this.num),
				num: 3,
				key: 'KeyD'
			},
			KeyF: {
		  		src: [{note: 'D', track: 'trombone/long/dLong.mp3'}, {note: 'G', track: 'trombone/long/gLong.mp3'}, {note: 'G', track: 'trombone/long/gLowLong.mp3'}],
				// pos: window.globals.calcPosition(this.num),
				num: 4,
				key: 'KeyF'
			},
			KeyG: {
		  		src: [{note: 'D Flat', track: 'trombone/long/dFlatLong.mp3'}, {note: 'G Flat', track: 'trombone/long/gFlatLong.mp3'}, {note: 'G Flat', track: 'trombone/long/gFlatLowLong.mp3'}],
				// pos: window.globals.calcPosition(this.num),
				num: 5,
				key: 'KeyG'
			},
			KeyH: {
		  		src: [{note: 'C', track: 'trombone/long/cLong.mp3'}, {note: 'F', track: 'trombone/long/fLong.mp3'}, {note: 'F', track: 'trombone/long/fLowLong.mp3'}],		
				// pos: window.globals.calcPosition(this.num),
				num: 6,
				key: 'KeyH'
			},
			KeyJ: {
		  		src: [{note: 'B', track: 'trombone/long/bLong.mp3'}, {note: 'E', track: 'trombone/long/eLong.mp3'}, {note: 'E', track: 'trombone/long/eLowLong.mp3'}],  			
				// pos: window.globals.calcPosition(this.num),
				num: 7,
				key: 'KeyJ'
			}
		}	

		mouseDown = document.addEventListener('mousedown', callMouseDown);
		mouseMove = document.addEventListener('mousemove', callMouseMove);
		mouseUp = document.addEventListener('mouseup', callMouseUp);
		keyDown = document.addEventListener('keydown', callKeyDown);
		keyUp = document.addEventListener('keyup', callKeyUp);
		arrowKey = document.addEventListener('keydown', isArrowKey);

		if(sliding){
			keyDown.preventDefault();
			arrowKey.preventDefault();
		}

		if(soundKeys >= 1  || isLeftRight) {
			mouseDown.preventDefault();
			mouseMove.preventDefault();
			mouseUp.preventDefault();
		}

	} //end window.onload

	//TESTING FUNCTIONS
	let title = document.getElementById("headline");
	let note = document.getElementById("note");

	title.addEventListener("click", (e) => {
		console.log(activeSound);
		checkStatus();
	})

	//KEYBOARD EVENT HANDLERS

		function callKeyDown(e){ //one key down
		keyed = e.code;
		//window.globals.repeat = e.repeat;
		isArrowKey(keyed, false, e.repeat);

			if(e.repeat){ 
				needsSoundRepeat();
				return;
			} else {		
			if(keyData[keyed] && (!e.getModifierState('Meta')) && !sliding){
				callKeyMovement(keyed);
				return;
			} 
		}

	}

	function callKeyMovement(keyed) {  //call slide postition movement based off key
		activeKey = keyed; //active sound key
					soundKeys++; //pressed sound key count
					if(soundKeys > 1){   //prevent sound overlap
						soundKeys--;
						sound.fade(1,0,300);  
					} 
					console.log(activeKey + "AKey")
					playSound(activeKey);
					//slide animation
					window.globals.moveSlide(keyData[activeKey].num);
					return;

	}

	function callKeyUp(e){ //on key up
		released = e.code;

		isArrowKey(released, true, false);
		callKeyRelease(released);
	}

	function callKeyRelease(released){  //if key released
		if(released === activeKey && !sliding){
				soundKeys--;
				console.log("keyup activeKey " + activeKey, "key released " + released);
				console.log("soundKeys");
				sound.fade(1,0,300);
				activeKey = null;
				note.innerHTML = '';
				//checkStatus();
				return;
			}
	}

	//Arrow Key Functions

	function isArrowKey(keyed, isReleased, isRepeat) {  //if key down is an arrow key
		let released = isReleased;
		let repeat = isRepeat;

		if(keyed === 'ArrowUp' || keyed === 'ArrowDown'){

			if(released){
				register = 0;
				if(activeKey){
					sound.fade(1,0,300);
					playSound(activeKey);
					return;
				}
			}else {		
				if(repeat) {
					needsSoundRepeat();
					return;
				} else {
					getRegister(keyed);
					if(activeKey) {
						sound.fade(1,0,300);
						playSound(activeKey);
						return;	
					}
				}
			}
			return;
		}


		if((keyed === 'ArrowLeft' || keyed === 'ArrowRight') && (!sliding)){
			isLeftRight = true;
			if(released){
				console.log("Active"  + activeKey)
				callKeyRelease(activeKey);
				isLeftRight = false;
				return;
			}else {
				if(repeat){
					coorKey = activeKey;
					needsSoundRepeat();
					return;	
				}else{
					let coorKey = getKey(window.globals.getSlideX() - 114);
					let coorNum = keyData[coorKey].num;
					let nextPos = getStep(keyed, keyData[coorKey].num);
					console.log("coorKey " + coorKey)

					coorNum = nextPos;

					let objArr = Object.values(keyData);
					let nextKey;

					for(var i = 0; i < objArr.length; i++){
						if(objArr[i].num === coorNum){
							nextKey = objArr[i].key;
						}
					}
					callKeyMovement(nextKey);
				}
			}
		}
	}

	//MOUSE EVENT HANDLERS

	function callMouseDown(e) {  //on mouse down - mainly sound handler
		if(soundKeys === 0) {  //if there is an active sound 
			//isArrowKey(e)
			sliding = true;
			if(e.offsetX > 250 && e.offsetX < 966){
				if(activeSound){	
					sound.fade(1,0,200);
				}

				activeKey = getKey(e.offsetX);
				playSound(activeKey);
				//console.log(sound.playing());

				window.globals.mouseDraggery({point: {x: e}});
				return;
			} 
	
		} else {
			sliding  = false;
			return;
		}

	}

	function callMouseMove(e) {  //on mouse drag - cooresponding sound handler
		
		if(soundKeys === 0){	
			if(sliding === true){
				if(e.offsetX > 250 && e.offsetX < 966){
					coorKey = getKey(e.offsetX);

					if(coorKey != activeKey){
						sound.fade(1,0,300);
						activeKey = coorKey; 
						playSound(activeKey);
						window.globals.mouseDraggery({point: {x: e}});
						return;	
					}
						
				}else {  //if outside side bounds
					console.log("mousemove not slide not moving // out of bounds " + sliding);
					return;
				}
			}
		}
	}

	function callMouseUp(e) {  // on mouse up
		if(sliding){
		sliding = false;
		sound.fade(1,0,200);
		activeSound = false;
		activeKey = null;
		}
		note.innerHTML = '';
		//checkStatus();
		return;
	}


	//SOUND FUNCTIONS

	function playSound(key) {  //play sound
		sound = new Howl({
			src: keyData[key].src[register].track,
			onfade: function(){
				this.stop();
				activeSound = false;
			}
		});
		sound.play();
		activeSound = sound.playing();

		note.innerHTML = keyData[key].src[register].note; // + " Active Sound: " + activeSound;
	}

	function repeatNote(key, fadeTime) { //if note is repeated - not sure if still needed for arrow keys

	}

	function needsSoundRepeat(){   //if key is held on repeat - checks to see if getting close to sound track end to reset it with minimal lag
		let checkEnd = sound.duration() - 0.15; //point near end for range to catch seek 
		let currentPlace = sound.seek(); //current track seek placement
		if(currentPlace > checkEnd){ //are we getting close to end?
			sound.seek(0.15);  //reset seek to repeat 
		}
	}


	//COORESPONDING VALUES FUNCTIONS

	function getKey(num){ //get cooresponding sounds from key data when sliding

		let key;

		if(num > 250 && num <= 365){
			key = 'KeyA';
		}else
	
		if(num <= 480){
			key = 'KeyS';
		} else

		if(num <= 595){
			key = 'KeyD';
		} else

		if(num <= 710){
			key = 'KeyF';
		} else

		if(num <= 825){
			key = 'KeyG';
		} else

		if(num <= 937){
			key = 'KeyH';
		} else

		if(num > 937 && num < 970){
			key = 'KeyJ';
		} 

		return key;	

	}

	function getRegister(selected){  //change note range (high or low)
			(selected === 'ArrowUp') ? register = 1 : register = 2;
			window.globals.reg = register; 
	}

	function getStep(selected, num){  //change slide position from left or right arrow keys
			(selected === 'ArrowLeft' && num === 1) ? num = 1 : num++; 
			(selected === 'ArrowRight' && num === 7) ? num = 7 : num--; 
			((num > 1 && num < 7) && selected === 'ArrowLeft' ) ? num-- : num++;
			return num; 
	}


	//INACTIVITY AND OTHER OPERATIONAL FUNCTIONS

	function checkStatus() {  //check inactivity
		if(!sliding && soundKeys === 0){  //fix this - need cancel if 
				var intervalID = setTimeout(() => { restoreSlide('one', 'two'); }, 3000);
		} 
		return;
	}

	function restoreSlide(){  //move back to first position/initial if user inactive
		window.globals.backToFirst();
	}

	function clearAlert() {
		window.clearTimeout(timeoutID);
	}


</script>

</html>