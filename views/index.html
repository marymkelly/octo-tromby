<!DOCTYPE html>
<html>
<head>
	<title>Tromby - Trombone Simulator</title>
	<!-- Load the Paper.js library -->
	<script type="text/javascript" src="js/paper-full.js"></script>
	<script type="text/javascript" src="js/howler.js"></script>
	<!-- Define inlined PaperScript associate it with myCanvas -->
	<script type="text/paperscript" canvas="myCanvas">

	//paper/canvas variables
	var pWidth = view.bounds.width;
	var pHeight = view.bounds.height;
	var midY = pHeight / 2;
	var midX = pWidth / 2;

	var pSeventh = ((pWidth - 250) / 7);
	//shape variables
	var width = 100;
	var height = 100;
	//calculate slide positions
	var seventh = (pWidth - (width * 1.5)) / 7; 
	//rectangle for testing position
	var rectSize = new Size(width, height);
	var rectPoint = new Point(width , (midY - (rectSize.height/2)));

	//trombone vars
	var trombone;
	var slide;
	var slSvgSev;
	var initSlideX; //386.6667 center X of slide
	var maxSlideX; //1586.2 max point for center X of slide
	var offset; // // 140 from the right side of canvas 
	var slideSeventh; // equal division of 7 parts //100.07 each

	//slide svg relative ~ not canvas
	var topSlide; //initSlideX - offset; // 245 - static // top of slide and left bound of animation
	var bottomSlide; // 1085 - static
	var leftSlSvg; // ((slide.bounds.width / 2) - (pWidth / 3)); // left endpoint x of slide svg 
	var rightSlSvg; // ((slide.bounds.width / 2) + (pWidth / 3)); // right endpoint x of slide svg 

	var propoX = 1401 /pWidth;
	var propoY = 490 / pHeight;

	var rect = new Shape.Rectangle(rectPoint, rectSize);
	//rect.fillColor = 'blue';

	paper.project.importSVG('/images/belltb.svg', function(onload) { //background trombone image
		trombone = onload;
	
		trombone.bounds.width;
		trombone.position = new Point((pWidth / 3), midY);
	});

	paper.project.importSVG('/images/slidetb.svg', function(onload) { //animated trombone slide
		slide = onload;
		
		slide.scale(1,1);
		//console.log(slide.bounds);
		slide.position = new Point((pWidth / 3), midY); 

		slSvgSev = (slide.bounds.width / 7); // for calculating max center X
		initSlideX = slide.position.x;
		maxSlideX = initSlideX + (slide.bounds.width - slSvgSev); //supposed to be max center X

		leftSlSvg = ((slide.bounds.width / 2) - (pWidth / 3)); // left endpoint x of slide svg 
		rightSlSvg = ((slide.bounds.width / 2) + (pWidth / 3)); // right endpoint x of slide svg
		offset = (pWidth - (slide.bounds.width - (pWidth / 3))); //from right side of canvas 
		topSlide = initSlideX - offset; // 245 - static
		bottomSlide = rightSlSvg; // 1085
		slideSeventh = (bottomSlide - topSlide) / 7; 

		//slide.strokeColor = "purple";
		//slide.strokeWidth = 2;

		console.log("pW " + pWidth + "pH " + pHeight + "sl " + slide.bounds); 

	});

	var myPath;

	function onMouseDown(event) {
		myPath = new Path();
		//myPath.strokeColor = 'black';

		if(event.point.x >= (topSlide) && event.point.x <= (bottomSlide - offset)){
			if(event.point.x <= (topSlide + 20)) {
				slide.position.x = event.point.x + 125;
			} else {
				slide.position.x = event.point.x + 105;
			}
		}
		console.log("mousey");

	}

	function onMouseDrag(event) {
		myPath.add(event.point);
		rect.position.x = event.point.x;

		console.log(slide.bounds);

		//max and min slide range
		if(event.point.x >= (topSlide) && event.point.x <= (bottomSlide - offset)){

			if(event.point.x <= (topSlide + 20)) {
				slide.position.x = event.point.x + 125;
			}else if(event.point.x >= (bottomSlide - (offset + 20))){
					slide.position.x = event.point.x + 115;
			}else {
					slide.position.x = event.point.x + 105;
			}
		}
	}

	//console.log('paper width ' + pWidth, 'paper height' + pHeight);

	globals.calcPosition = function(s){
		return seventh * s;
	};

	globals.moveSlide = function(s){
		var opt = opt;
		var moveSlide = (slSvgSev * (s - 1))/1.77;
		var newSlidePos = initSlideX + moveSlide;

		slide.tween({
			'position.x': newSlidePos,
		}, {
			easing: 'easeInOutCubic',
		    duration: 200
		});

		console.log("newX " + newSlidePos);
		console.log(slideSeventh);
	};

	globals.tween = function(num) {
			
		rect.tween({
		    'position.x': num,
		    'fillColor.hue': '+= 90'
		}, {
		    easing: 'easeInOutCubic',
		    duration: 200
		});

		//console.log(slide.position, 'slSev ' + slSev);
	}

	globals.backToFirst = function(){
		if(slide.position.x === topSlide){
			console.log('all good!');
			
		} else {
			console.log("working on it shortly");
			globals.moveSlide(1);
		}
	}


	// console.log(paper.project._view._id); //paperScope object id
	paper.install(window);  //inject into window global scope

	</script>
</head>

<style>
#myCanvas {
	border: 2px solid red;
}

html,
body {
    height: 100%;
}

/* Scale canvas with resize attribute to full size */
canvas[resize] {
    width: 80vw;
    height: 90vh;

/*    width: 1156px;
    height: 529px;*/
}

</style>


<body>
	<h1 id="headline">Hello World!</h1>
	<canvas id="myCanvas" resize></canvas>


</body>
<script type="text/javascript">

	window.globals = {}

	let activeKey; //most recent key down
	let soundKeys = 0; //track pressed sound keys 
	let sound;
	let register = 0; //note ranges
	let keyData = {};
	let sliding = false; //sliding mouse
	let coorKey; //corresponding 'key' 
	let activeSound = false; //active sound if mousedown
	let isKeyPress;
	let keyvent;
	let mousevent; 
	let initCount = 0; 
	let mouseUp;
	let keyDown


	window.onload = function(){

		keyData = {
			KeyA: {
		  		src: ['trombone/long/fLong.mp3', 'trombone/long/bFlatHighLong.mp3', 'trombone/long/bFlatLong.mp3'],
				pos: window.globals.calcPosition(1),
				num: 1
			},
			KeyS: {
		  		src: ['trombone/long/eLong.mp3', 'trombone/long/aLong.mp3', 'trombone/long/aLowLong.mp3'],
				pos: window.globals.calcPosition(2),
				num: 2
			},
			KeyD: {
		  		src: ['trombone/long/eFlatLong.mp3', 'trombone/long/aFlatLong.mp3', 'trombone/long/aFlatLowLong.mp3'],
				pos: window.globals.calcPosition(3),
				num: 3
			},
			KeyF: {
		  		src: ['trombone/long/dLong.mp3', 'trombone/long/gLong.mp3', 'trombone/long/gLowLong.mp3'],
				pos: window.globals.calcPosition(4),
				num: 4
			},
			KeyG: {
		  		src: ['trombone/long/dFlatLong.mp3', 'trombone/long/gFlatLong.mp3', 'trombone/long/gFlatLowLong.mp3'],
				pos: window.globals.calcPosition(5),
				num: 5
			},
			KeyH: {
		  		src: ['trombone/long/cLong.mp3', 'trombone/long/fLong.mp3', 'trombone/long/fLowLong.mp3'],		
				pos: window.globals.calcPosition(6),
				num: 6
			},
			KeyJ: {
		  		src: ['trombone/long/bLong.mp3', 'trombone/long/eLong.mp3', 'trombone/long/eLowLong.mp3'],  			
				pos: window.globals.calcPosition(7),
				num: 7
			}
		}

		if(Event.NONE){
			console.log("FUCKING A THIS");
		}
	

		document.addEventListener('mousedown', (e) => {
			// mousevent = true;
			if(!activeSound && soundKeys === 0){
				if(e.offsetX > 250 && e.offsetX < 966){
					sliding = true;
				
					activeKey = getKey(e.offsetX);

					playSound(activeKey);
					//soundKeys++;
					activeSound = sound.playing();
					return;
			
				} else {
					sliding = false;
					console.log('out of range ' + e.offsetX, "mouse down sliding " + sliding);
					console.log(soundKeys);
					return;
				}
			}else { //if there is an active sound
				if(soundKeys === 0) {
				sliding = true;
				sound.fade(1,0,200);
				if(e.offsetX > 250 && e.offsetX < 966){
					activeKey = getKey(e.offsetX);
					playSound(activeKey);
				}
				//console.log(soundKeys, "activeKey " + activeKey);
				//activeSound = sound.playing();
				return;
				}//if no soundkeys
			}
			return;
		})

		document.addEventListener('mousemove', (e) => {
			
			if(sliding === true){
				//console.log(activeSound);
				if(e.offsetX > 250 && e.offsetX < 966){
					coorKey = getKey(e.offsetX);
					console.log(coorKey);
					if(coorKey != activeKey){
						sound.fade(1,0,300);
						activeKey = coorKey; 
						playSound(activeKey);
						return;	
					}
						
				}else {  //if outside side bounds
					console.log("mousemove not slide not moving // out of bounds " + sliding);
					return;
				}
			}// else { // if not sliding
				//e.preventDefault();
				//checkStatus();
				// console.log("you shouldn't be here" + sliding);
				// console.log("active sound? " + activeSound, "soundKeys??" + soundKeys);
				return;
			//}
		})

		function getKey(num){

			let key;

			if(num > 250 && num <= 365){
				key = 'KeyA';
			}else
		
			if(num <= 480){
				key = 'KeyS';
			} else

			if(num <= 595){
				key = 'KeyD';
			} else

			if(num <= 710){
				key = 'KeyF';
			} else

			if(num <= 825){
				key = 'KeyG';
			} else

			if(num <= 925){
				key = 'KeyH';
			} else

			if(num > 925 && num < 970){
				key = 'KeyJ';
			} 

			return key;	

		}

		mouseUp = document.addEventListener('mouseup', callMouseUp);

		keyDown = document.addEventListener('keydown', callKeyDown);

		document.addEventListener('keyup', (e) => {
			released = e.code;

			if(activeKey){
				if((released === 'ArrowUp' || released === 'ArrowDown') && (activeKey)){
					register = 0;
					sound.fade(1,0,300);
					playSound(activeKey);
					//return;
				}

				if(released === activeKey && !sliding){
					soundKeys--;
					//console.log("keyup activeKey " + activeKey, "key released " + released);
					sound.fade(1,0,300);
					activeKey = null;
					checkStatus();
					return;
				}
			} else {

				if(released === 'ArrowUp' || released === 'ArrowDown') {
				register = 0;
				console.log("release arrow" + register);
				}
				console.log("active key on arrow release" + activeKey);
				console.log("active sound" + activeSound);
				return;
			}

			//console.log("key up: " + e.key, "up reported activeKey: " + activeKey);
		});
	} //end window.onload


	var title = document.getElementById("headline");

	title.addEventListener("click", (e) => {
		console.log("fucker");
		console.log("ePhase" + event.eventPhase);
		console.log("e" + e.eventPhase);
		checkStatus();


		//console.log(mouseUp.eventPhase);
	})

	function playSound(key) {  //play sound
		sound = new Howl({
			src: keyData[key].src[register],
			onfade: function(){
				this.stop();
			}
		});
		sound.play();
	}

	function callKeyDown(e){
		keyed = e.code;

				if(e.repeat && activeKey) {  		//on held down sound key, check to repeat sound
						needsSoundRepeat();
						console.log("I am after the repeat");

				} else { 							//new key 							

					if((keyed === 'ArrowUp' || keyed === 'ArrowDown') && (activeKey)) { //to change note range 
							getRegister(keyed);
							sound.fade(1,0,300);
							playSound(activeKey);
							return;
					}
			
					if(keyData[keyed] && (!e.getModifierState('Meta')) && !sliding){
						activeKey = keyed; //active sound key
						soundKeys++; //pressed sound key count
						if(soundKeys > 1){   //prevent sound overlap
							soundKeys--;
							sound.fade(1,0,300);  
						} 

						playSound(activeKey);
						//square animation
						//window.globals.tween(keyData[activeKey].pos);
						//slide animation
						window.globals.moveSlide(keyData[activeKey].num);
						return;
					} else {
						
						if(keyed === 'ArrowUp' || keyed === 'ArrowDown'){
						getRegister(keyed);
						console.log("press arrow 5" + register);
						}
						//console.log("no assigned sound");
						console.log("active key arrow pressed" + activeKey);
						console.log("active sound" + activeSound);
						return;	
					}
				}	

				//console.log("down reported active key: " + activeKey);

	}

	function checkStatus() {

		if(!sliding && soundKeys === 0){
				var intervalID = setTimeout(() => { restoreSlide('one', 'two'); }, 3000);
		}
		return;

	}

	function restoreSlide(){
		window.globals.backToFirst();
	}


	function clearAlert() {
	  window.clearTimeout(timeoutID);
	}

	function callMouseUp(e) {
		// mousevent = false;
		if(sliding){
		sliding = false;
		//soundKeys--;
		sound.fade(1,0,200);
		activeSound = false;
		activeKey = null;
		//coorKey = null;
		}
		console.log("mouseEPh" + e.eventPhase);
		// console.log("called mouse up");
		checkStatus();
		return;
	}

	function getRegister(selected){  //change note range (high or low)
			(selected === 'ArrowUp') ? register = 1 : register = 2;
	}

	function needsSoundRepeat(){   //checks to see if getting close to sound track end to reset it with minimal lag
		let checkEnd = sound.duration() - 0.15; //point near end for range to catch seek 
		let currentPlace = sound.seek(); //current track seek placement
		if(currentPlace > checkEnd){ //are we getting close to end?
			sound.seek(0.15);  //reset seek to repeat 
		}
	}

</script>

</html>