<!DOCTYPE html>
<html>
<head>
	<title>Tromby - Trombone Simulator</title>
	<!-- Load the Paper.js library -->
	<script type="text/javascript" src="js/paper-full.js"></script>
	<script type="text/javascript" src="js/howler.js"></script>
	<!-- Define inlined PaperScript associate it with myCanvas -->
	<script type="text/paperscript" canvas="myCanvas">

	//paper/canvas variables
	var pWidth = view.bounds.width;
	var pHeight = view.bounds.height;
	var midY = pHeight / 2;
	var midX = pWidth / 2;

	//shape variables
	var width = 100;
	var height = 100;
	//calculate slide positions
	var seventh = (pWidth - (width * 1.5)) / 7;
	//rectangle for testing position
	var rectSize = new Size(width, height);
	var rectPoint = new Point(width , (midY - (rectSize.height/2)));
	var trombone;
	var slide;
	var slSev;
	var initSlideX; 

	var rect = new Shape.Rectangle(rectPoint, rectSize);
	rect.fillColor = 'blue';

	paper.project.importSVG('/images/bell.svg', function(onload) {
		trombone = onload;
		
		trombone.scale(1);
		//console.log(trombone.bounds);
		trombone.position = new Point(pWidth/3, midY);

	});

	paper.project.importSVG('/images/slide.svg', function(onload) {
		slide = onload;
		
		slide.scale(1);
		//console.log(slide.bounds);
		slide.position = new Point((pWidth / 1.66), (pHeight / 1.515));
		slSev = (slide.bounds.width / 7);
		initSlideX = slide.position.x;

	});

	//console.log('paper width ' + pWidth, 'paper height' + pHeight);

	globals.calcPosition = function(s){
		return seventh * s;
	};

	globals.moveSlide = function(s){

		var moveSlide = slSev * (s - 1);
		var newSlidePos = initSlideX + moveSlide;

		slide.tween({
			'position.x': newSlidePos,
		}, {
			easing: 'easeInOutCubic',
		    duration: 200
		});
	};

	globals.tween = function(num) {
			
		rect.tween({
		    'position.x': num,
		    'fillColor.hue': '+= 90'
		}, {
		    easing: 'easeInOutCubic',
		    duration: 200
		});

		//console.log(slide.position, 'slSev ' + slSev);
	}

	function testing(){
		console.log("paper says hi");
	}
	 
	function onResize(event) {
	   // Whenever the window is resized, recenter the path:
	   //rect.position = view.center;
	}

	// console.log(paper.project._view._id); //paperScope object id
	paper.install(window);  //inject into window global scope

	</script>
</head>

<style>
#myCanvas {
	border: 2px solid red;
}

html,
body {
    height: 100%;
}

/* Scale canvas with resize attribute to full size */
canvas[resize] {
/*    width: 80vw;
    height: 90vh;*/

    width: 1156px;
    height: 529px;
}

</style>


<body>
	<h1 id="headline">Hello World!</h1>
	<canvas id="myCanvas" resize></canvas>


</body>
<script type="text/javascript">

	window.globals = {}

	let activeKey; //most recent key down
	let soundKeys = 0; //track pressed sound keys 
	let sound;
	let register = 0; //note ranges
	let keyData = {}

	window.onload = function(){

		keyData = {
			KeyA: {
		  		src: ['trombone/long/fLong.mp3', 'trombone/long/bFlatHighLong.mp3', 'trombone/long/bFlatLong.mp3'],
				pos: window.globals.calcPosition(1),
				num: 1
			},
			KeyS: {
		  		src: ['trombone/long/eLong.mp3', 'trombone/long/aLong.mp3', 'trombone/long/aLowLong.mp3'],
				pos: window.globals.calcPosition(2),
				num: 2
			},
			KeyD: {
		  		src: ['trombone/long/eFlatLong.mp3', 'trombone/long/aFlatLong.mp3', 'trombone/long/aFlatLowLong.mp3'],
				pos: window.globals.calcPosition(3),
				num: 3
			},
			KeyF: {
		  		src: ['trombone/long/dLong.mp3', 'trombone/long/gLong.mp3', 'trombone/long/gLowLong.mp3'],
				pos: window.globals.calcPosition(4),
				num: 4
			},
			KeyG: {
		  		src: ['trombone/long/dFlatLong.mp3', 'trombone/long/gFlatLong.mp3', 'trombone/long/gFlatLowLong.mp3'],
				pos: window.globals.calcPosition(5),
				num: 5
			},
			KeyH: {
		  		src: ['trombone/long/cLong.mp3', 'trombone/long/fLong.mp3', 'trombone/long/fLowLong.mp3'],		
				pos: window.globals.calcPosition(6),
				num: 6
			},
			KeyJ: {
		  		src: ['trombone/long/bLong.mp3', 'trombone/long/eLong.mp3', 'trombone/long/eLowLong.mp3'],  			
				pos: window.globals.calcPosition(7),
				num: 7
			}
		}

		document.addEventListener('keydown', (e) => {
			keyed = e.code;
			// console.log(e.getModifierState('Alt'));
			// console.log(e.getModifierState('Meta'));

				if(e.repeat && activeKey) {  		//on held down sound key, check to repeat sound
					needsSoundRepeat();
				} else { 							//new key 							

					if((keyed === 'ArrowUp' || keyed === 'ArrowDown') && (activeKey)) { //to change note range 
							getRegister(keyed);
							sound.fade(1,0,300);
							playSound(activeKey);
							return;
					}
			
					if(keyData[keyed] && (!e.getModifierState('Meta'))){
						activeKey = keyed; //active sound key
						soundKeys++; //pressed sound key count
						if(soundKeys > 1){   //prevent sound overlap
							sound.fade(1,0,300);  
						} 

						playSound(activeKey);
						//square animation
						window.globals.tween(keyData[activeKey].pos);
						//slide animation
						window.globals.moveSlide(keyData[activeKey].num);
						return;
					} else {
						//console.log("no assigned sound");
						return;	
					}
				}	
				//console.log("down reported active key: " + activeKey);
		});

		document.addEventListener('keyup', (e) => {
			released = e.code;

			if((released === 'ArrowUp' || released === 'ArrowDown') && (activeKey)){
				register = 0;
				sound.fade(1,0,300);
				playSound(activeKey);
				return;
			}

			if(released === activeKey){
				soundKeys--;
				sound.fade(1,0,300);
				activeKey = null;
				return;

			} else {
				return;
			}
			//console.log("key up: " + e.key, "up reported activeKey: " + activeKey);
		});
	} //end window.onload

	function playSound(key) {  //play sound
		sound = new Howl({
			src: keyData[key].src[register],
			onfade: function(){
				this.stop();
			}
		});
		sound.play();
	}

	function getRegister(selected){  //change note range (high or low)
			(selected === 'ArrowUp') ? register = 1 : register = 2;
	}

	function needsSoundRepeat(){   //checks to see if getting close to sound track end to reset it with minimal lag
		let checkEnd = sound.duration() - 0.15; //point near end for range to catch seek 
		let currentPlace = sound.seek(); //current track seek placement
		if(currentPlace > checkEnd){ //are we getting close to end?
			sound.seek(0.15);  //reset seek to repeat 
		}
	}

</script>

</html>